<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>嘉里集團健康室建管系統 - 完整全功能版</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #fffaf0;
            margin: 0;
            -webkit-font-smoothing: antialiased;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #fed7aa; border-radius: 10px; }
        .kerry-gradient { background: linear-gradient(135deg, #F37021 0%, #ff8c42 100%); }
        
        @media print {
            .print\:hidden { display: none !important; }
            main { margin-left: 0 !important; padding: 0 !important; width: 100% !important; }
            #newsletter-content { border: none !important; box-shadow: none !important; border-radius: 0 !important; width: 100% !important; }
            .bg-orange-50 { background-color: #fff7ed !important; -webkit-print-color-adjust: exact; }
            .bg-slate-900 { background-color: #0f172a !important; -webkit-print-color-adjust: exact; color: white !important; }
            .kerry-gradient { background: #F37021 !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 小工具：圖標渲染 ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const iconData = (window.lucide && window.lucide.icons && window.lucide.icons[name]) ? window.lucide.icons[name] : null;
            if (!iconData) return <span style={{ width: size, height: size }} className={`inline-block ${className}`} />;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {iconData.map((item, index) => React.createElement(item[0], { key: index, ...item[1] }))}
                </svg>
            );
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return '未定';
            const d = new Date(dateStr);
            return `${d.getFullYear()}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}`;
        };

        const getMonthName = (monthOffset = 0) => {
            const d = new Date();
            d.setMonth(d.getMonth() + monthOffset);
            return `${d.getFullYear()}年 ${d.getMonth() + 1}月`;
        };

        function App() {
            // --- 資料狀態 (由 LocalStorage 驅動) ---
            const [projects, setProjects] = useState(() => JSON.parse(localStorage.getItem('kj_projects') || '[]'));
            const [tasks, setTasks] = useState(() => JSON.parse(localStorage.getItem('kj_tasks') || '[]'));
            const [members, setMembers] = useState(() => JSON.parse(localStorage.getItem('kj_members') || '[{"id":"m1","name":"羽瑩"},{"id":"m2","name":"嘉莉"}]'));
            const [routines, setRoutines] = useState(() => JSON.parse(localStorage.getItem('kj_routines') || '[{"id":"r1","title":"醫藥箱盤點","frequency":"每月","assignee":"羽瑩"}]'));
            
            const [activeTab, setActiveTab] = useState('dashboard');
            const [message, setMessage] = useState({ show: false, text: '', type: 'info' });

            // UI 控制
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isEditModalOpen, setIsEditModalOpen] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);
            const [importText, setImportText] = useState('');

            // 表單暫存
            const [projectForm, setProjectForm] = useState({ id: '', title: '', leader: '', description: '', startDate: '', endDate: '' });
            const [newTask, setNewTask] = useState({ projectId: '', title: '', assignee: '', startDate: '', endDate: '' });
            const [newRoutine, setNewRoutine] = useState({ title: '', frequency: '每月', assignee: '' });
            const [newMemberName, setNewMemberName] = useState('');

            // --- 自動儲存機制 ---
            useEffect(() => {
                localStorage.setItem('kj_projects', JSON.stringify(projects));
                localStorage.setItem('kj_tasks', JSON.stringify(tasks));
                localStorage.setItem('kj_members', JSON.stringify(members));
                localStorage.setItem('kj_routines', JSON.stringify(routines));
            }, [projects, tasks, members, routines]);

            const showMsg = (text, type = 'info') => {
                setMessage({ show: true, text, type });
                setTimeout(() => setMessage({ show: false, text: '', type: 'info' }), 3000);
            };

            // --- 報表數據計算 ---
            const memberNames = members.map(m => m.name);
            const stats = useMemo(() => projects.map(p => {
                const pt = tasks.filter(t => t.projectId === p.id);
                const done = pt.filter(t => t.status === 'completed').length;
                return { ...p, percent: pt.length > 0 ? Math.round((done / pt.length) * 100) : 0, total: pt.length, done };
            }), [projects, tasks]);

            const newsletter = useMemo(() => {
                const now = new Date();
                const curY = now.getFullYear(), curM = now.getMonth();
                const nextY = curM === 11 ? curY + 1 : curY;
                const nextM = curM === 11 ? 0 : curM + 1;
                const isM = (d, y, m) => { if(!d) return false; const dt = new Date(d); return dt.getFullYear() === y && dt.getMonth() === m; };
                
                return {
                    thisMonth: tasks.filter(t => isM(t.endDate, curY, curM)).sort((a,b)=>new Date(a.endDate)-new Date(b.endDate)),
                    nextMonth: tasks.filter(t => isM(t.endDate, nextY, nextM)).sort((a,b)=>new Date(a.endDate)-new Date(b.endDate))
                };
            }, [tasks]);

            // --- 功能函式 ---
            const handleAddProject = (e) => {
                e.preventDefault();
                setProjects([...projects, { ...projectForm, id: 'p' + Date.now() }]);
                setIsModalOpen(false);
                setProjectForm({ id: '', title: '', leader: '', description: '', startDate: '', endDate: '' });
                showMsg('大專案啟動成功', 'success');
            };

            const handleAddTask = (e, pid) => {
                e.preventDefault();
                if (!newTask.title || !newTask.startDate || !newTask.endDate) return;
                setTasks([...tasks, { ...newTask, id: 't' + Date.now(), projectId: pid, status: 'pending' }]);
                setNewTask({ ...newTask, title: '' });
                showMsg('任務指派成功');
            };

            const handleAddRoutine = (e) => {
                e.preventDefault();
                if (!newRoutine.title) return;
                setRoutines([...routines, { ...newRoutine, id: 'r' + Date.now() }]);
                setNewRoutine({ title: '', frequency: '每月', assignee: memberNames[0] });
                showMsg('常規工作已新增');
            };

            const handleImportCSV = () => {
                const lines = importText.split('\n').filter(l => l.trim());
                const items = lines.map(line => {
                    const [t, f, a] = line.split(',').map(s => s?.trim());
                    return { id: 'r' + Math.random(), title: t, frequency: f || '每月', assignee: a || memberNames[0] };
                });
                setRoutines([...routines, ...items]);
                setImportText('');
                setShowImportModal(false);
                showMsg(`匯入 ${items.length} 筆成功`);
            };

            return (
                <div className="flex min-h-screen relative">
                    {/* 通知訊息 */}
                    {message.show && (
                        <div className={`fixed top-5 left-1/2 -translate-x-1/2 z-[100] px-8 py-4 rounded-2xl shadow-2xl flex items-center gap-4 animate-bounce ${message.type === 'success' ? 'bg-green-600 text-white' : 'bg-slate-800 text-white'}`}>
                            <Icon name={message.type === 'success' ? "CheckCircle2" : "AlertCircle"} size={24} />
                            <span className="font-black">{message.text}</span>
                        </div>
                    )}

                    {/* 側邊導覽 */}
                    <aside className="print:hidden fixed h-full w-64 bg-white border-r border-orange-100 flex flex-col z-20 shadow-xl">
                        <div className="p-8 border-b border-orange-50 bg-white">
                            <h1 className="text-xl font-black text-[#F37021] tracking-tighter">嘉里集團健康室</h1>
                            <p className="text-[10px] text-slate-400 font-bold uppercase mt-1 italic tracking-widest leading-none">Management System</p>
                        </div>
                        <nav className="flex-1 p-6 space-y-2 overflow-y-auto custom-scrollbar">
                            <button onClick={() => setActiveTab('dashboard')} className={`w-full flex items-center gap-4 px-4 py-3 rounded-2xl transition-all ${activeTab === 'dashboard' ? 'kerry-gradient text-white shadow-xl shadow-orange-200' : 'text-slate-500 hover:bg-orange-50'}`}>
                                <Icon name="LayoutDashboard" size={18} /> <span className="font-bold">專案看板</span>
                            </button>
                            <button onClick={() => setActiveTab('weekly')} className={`w-full flex items-center gap-4 px-4 py-3 rounded-2xl transition-all ${activeTab === 'weekly' ? 'bg-slate-900 text-white shadow-xl' : 'text-slate-500 hover:bg-orange-50'}`}>
                                <Icon name="BarChart3" size={18} /> <span className="font-bold">報表電子報</span>
                            </button>
                            <button onClick={() => setActiveTab('routine')} className={`w-full flex items-center gap-4 px-4 py-3 rounded-2xl transition-all ${activeTab === 'routine' ? 'bg-emerald-600 text-white shadow-xl' : 'text-slate-500 hover:bg-orange-50'}`}>
                                <Icon name="Repeat" size={18} /> <span className="font-bold">常規管理</span>
                            </button>
                            
                            <div className="pt-8 border-t border-orange-50 mt-6">
                                <p className="text-[10px] font-black text-slate-300 px-4 uppercase mb-2 italic">護理師團隊</p>
                                {memberNames.map(name => (
                                    <button key={name} onClick={() => setActiveTab(name)} className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-xl transition-all ${activeTab === name ? 'bg-orange-100 text-[#F37021] font-black' : 'text-slate-500 hover:bg-orange-50'}`}>
                                        <div className={`w-1.5 h-1.5 rounded-full ${activeTab === name ? 'bg-[#F37021]' : 'bg-slate-300'}`}></div>
                                        {name}
                                    </button>
                                ))}
                            </div>
                        </nav>
                        <div className="p-6 border-t border-orange-50">
                            <button onClick={() => setActiveTab('settings')} className={`w-full flex items-center gap-4 px-4 py-3 rounded-2xl transition-all ${activeTab === 'settings' ? 'bg-slate-700 text-white shadow-xl' : 'text-slate-500 hover:bg-orange-50'}`}>
                                <Icon name="Settings" size={18} /> <span className="font-bold">系統設定</span>
                            </button>
                        </div>
                    </aside>

                    {/* 主要內容區 */}
                    <main className="lg:ml-64 flex-1 p-4 md:p-10 min-h-screen">
                        
                        {/* 1. 專案看板頁面 */}
                        {activeTab === 'dashboard' && (
                            <div className="max-w-6xl mx-auto space-y-10 animate-in fade-in duration-500">
                                <header className="flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
                                    <div>
                                        <h2 className="text-4xl font-black text-slate-900 tracking-tighter uppercase">專案管理看板</h2>
                                        <p className="text-[#F37021] font-bold mt-2">任務精確分派 (起始/截止日)</p>
                                    </div>
                                    <button onClick={() => setIsModalOpen(true)} className="bg-[#F37021] text-white px-10 py-5 rounded-3xl font-black shadow-2xl flex items-center gap-3 hover:scale-105 transition-all">
                                        <Icon name="Plus" size={24} /> 啟動大專案
                                    </button>
                                </header>

                                <div className="grid md:grid-cols-2 gap-8">
                                    {stats.map(proj => (
                                        <div key={proj.id} className="bg-white rounded-[2.5rem] border border-orange-100 shadow-sm overflow-hidden flex flex-col hover:border-[#F37021] transition-all">
                                            <div className="p-8 border-b border-orange-50 relative">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <h3 className="text-2xl font-black text-slate-800 leading-tight">{proj.title}</h3>
                                                        <div className="flex gap-3 mt-4">
                                                            <span className="bg-orange-50 text-[#F37021] text-[10px] px-3 py-1 rounded-full font-black uppercase border border-orange-100">負責：{proj.leader}</span>
                                                            <span className="text-[10px] text-slate-400 font-bold flex items-center gap-1"><Icon name="Calendar" size={12}/> {formatDate(proj.startDate)} — {formatDate(proj.endDate)}</span>
                                                        </div>
                                                    </div>
                                                    <button onClick={()=>{setProjectForm(proj); setIsEditModalOpen(true);}} className="text-slate-300 hover:text-[#F37021]"><Icon name="Edit2" size={20}/></button>
                                                </div>
                                                <div className="mt-6 w-full bg-slate-100 h-2.5 rounded-full overflow-hidden">
                                                    <div className={`h-full transition-all duration-1000 ${proj.percent === 100 ? 'bg-emerald-500' : 'bg-[#F37021]'}`} style={{ width: `${proj.percent}%` }}></div>
                                                </div>
                                            </div>

                                            <div className="p-8 bg-orange-50/20 flex-1 space-y-4">
                                                {/* 強化任務指派區 (起訖日) */}
                                                <form onSubmit={(e) => handleAddTask(e, proj.id)} className="bg-white p-5 rounded-2xl border border-orange-100 shadow-sm space-y-3">
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <div><label className="text-[10px] font-black text-slate-400 ml-1">START 起始</label><input type="date" required className="w-full bg-slate-50 border border-orange-100 rounded-lg px-2 py-1.5 text-xs font-bold outline-none" value={newTask.projectId===proj.id?newTask.startDate:''} onChange={e=>setNewTask({...newTask, startDate:e.target.value, projectId:proj.id})} /></div>
                                                        <div><label className="text-[10px] font-black text-slate-400 ml-1">END 截止</label><input type="date" required className="w-full bg-slate-50 border border-orange-100 rounded-lg px-2 py-1.5 text-xs font-bold outline-none" value={newTask.projectId===proj.id?newTask.endDate:''} onChange={e=>setNewTask({...newTask, endDate:e.target.value, projectId:proj.id})} /></div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <select required className="bg-slate-50 border border-orange-100 rounded-lg px-2 py-1.5 text-xs flex-1 outline-none font-black" value={newTask.projectId===proj.id?newTask.assignee:''} onChange={e=>setNewTask({...newTask, assignee:e.target.value, projectId:proj.id})}>
                                                            <option value="">指派人員</option>
                                                            {memberNames.map(n=><option key={n} value={n}>{n}</option>)}
                                                        </select>
                                                        <input required placeholder="任務內容..." className="flex-[2] bg-slate-50 border border-orange-100 rounded-lg px-3 py-1.5 text-xs outline-none" value={newTask.projectId===proj.id?newTask.title:''} onFocus={()=>setNewTask({...newTask, projectId:proj.id, assignee: newTask.assignee||proj.leader})} onChange={e=>setNewTask({...newTask, title:e.target.value})} />
                                                        <button className="bg-slate-800 text-white px-5 py-1.5 rounded-lg text-xs font-black shadow-md">指派</button>
                                                    </div>
                                                </form>

                                                <div className="space-y-2 overflow-y-auto max-h-72 custom-scrollbar pr-2">
                                                    {tasks.filter(t => t.projectId === proj.id).map(t => (
                                                        <div key={t.id} className="bg-white p-4 rounded-2xl flex items-center justify-between border border-orange-50 group hover:border-orange-200">
                                                            <div className="flex items-center gap-4">
                                                                <button onClick={() => setTasks(tasks.map(tk => tk.id === t.id ? {...tk, status: tk.status==='completed'?'pending':'completed'} : tk))} className={t.status === 'completed' ? 'text-emerald-500' : 'text-slate-200'}>
                                                                    <Icon name="CheckCircle2" size={26} />
                                                                </button>
                                                                <div>
                                                                    <p className={`text-base font-black ${t.status === 'completed' ? 'line-through text-slate-300 font-normal opacity-60' : 'text-slate-800'}`}>{t.title}</p>
                                                                    <p className="text-[10px] text-slate-400 font-bold italic mt-1 uppercase tracking-tighter">
                                                                        {formatDate(t.startDate)} - {formatDate(t.endDate)} · {t.assignee}
                                                                    </p>
                                                                </div>
                                                            </div>
                                                            <button onClick={() => setTasks(tasks.filter(tk => tk.id !== t.id))} className="opacity-0 group-hover:opacity-100 text-red-200 hover:text-red-500"><Icon name="Trash2" size={18}/></button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* 2. 報表電子報頁面 */}
                        {activeTab === 'weekly' && (
                            <div className="max-w-4xl mx-auto space-y-10 animate-in fade-in duration-700">
                                <header className="flex justify-between items-center print:hidden">
                                    <h2 className="text-3xl font-black text-slate-800 uppercase tracking-widest">工作執行報表</h2>
                                    <button onClick={() => window.print()} className="bg-[#F37021] text-white px-8 py-4 rounded-2xl font-black shadow-2xl flex items-center gap-3"><Icon name="Printer" /> 匯出 PDF 報表</button>
                                </header>
                                <div id="newsletter-content" className="bg-white border border-orange-100 shadow-2xl rounded-[3rem] overflow-hidden print:shadow-none">
                                    <div className="bg-slate-900 text-white p-16 text-center">
                                        <div className="w-24 h-2 bg-[#F37021] mx-auto mb-8"></div>
                                        <h1 className="text-5xl font-black tracking-widest uppercase mb-2">嘉里集團健康室</h1>
                                        <p className="text-slate-400 font-bold text-xs uppercase italic tracking-[0.3em]">Health Management Report</p>
                                        <div className="mt-12 bg-white/5 px-8 py-3 rounded-full inline-block text-sm border border-white/10 font-bold italic">報告日期：{formatDate(new Date())}</div>
                                    </div>
                                    <div className="p-12 md:p-20 space-y-20">
                                        {/* 核心數據統計區 */}
                                        <section>
                                            <div className="flex items-center gap-4 mb-10 border-l-8 border-[#F37021] pl-6"><h3 className="text-3xl font-black text-slate-900 uppercase">年度大專案執行進度</h3></div>
                                            <div className="grid gap-12">
                                                {stats.map(s => (
                                                    <div key={s.id}>
                                                        <div className="flex justify-between font-black mb-3">
                                                            <span className="text-xl text-slate-700 leading-none">{s.title}</span>
                                                            <span className="text-3xl text-[#F37021] leading-none">{s.percent}%</span>
                                                        </div>
                                                        <div className="w-full bg-slate-100 h-6 rounded-full overflow-hidden shadow-inner flex border border-slate-50">
                                                            <div className="h-full kerry-gradient transition-all duration-1000" style={{width:`${s.percent}%`}}></div>
                                                        </div>
                                                        <div className="flex justify-between mt-3 text-[10px] font-black text-slate-300 italic uppercase tracking-widest leading-none">
                                                            <span>{s.done} 已完成項目</span>
                                                            <span>總計需求 {s.total} 項</span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </section>

                                        {/* 本月摘要 */}
                                        <section>
                                            <div className="flex items-center gap-4 mb-10 border-l-8 border-slate-800 pl-6"><h3 className="text-3xl font-black text-slate-900 uppercase">{getMonthName(0)} 重點執行摘要</h3></div>
                                            <div className="space-y-5">
                                                {newsletter.thisMonth.map(t=>(
                                                    <div key={t.id} className="flex items-center gap-8 bg-orange-50/30 p-8 rounded-3xl border border-orange-50">
                                                        <div className="text-3xl font-black text-slate-800 w-16 text-center border-r border-orange-200">{new Date(t.endDate).getDate()}日</div>
                                                        <div className="flex-1 font-black text-slate-800 text-xl">{t.title} <span className="text-xs text-[#F37021] font-bold">/ {t.assignee}</span></div>
                                                        {t.status==='completed'?<Icon name="CheckCircle2" className="text-emerald-500" size={30}/>:<Icon name="Clock" className="text-slate-200" size={30}/>}
                                                    </div>
                                                ))}
                                                {newsletter.thisMonth.length === 0 && <p className="text-slate-300 font-bold italic text-center py-10 border-2 border-dashed border-orange-100 rounded-3xl">本月無截止任務</p>}
                                            </div>
                                        </section>

                                        {/* 次月規劃 */}
                                        <section>
                                            <div className="flex items-center gap-4 mb-10 border-l-8 border-orange-400 pl-6"><h3 className="text-3xl font-black text-slate-900 uppercase">{getMonthName(1)} 次月規劃預告</h3></div>
                                            <div className="bg-slate-50 p-12 rounded-[3.5rem] border border-slate-100 space-y-8">
                                                {newsletter.nextMonth.map(t=>(
                                                    <div key={t.id} className="flex gap-6 items-start">
                                                        <div className="w-3 h-3 rounded-full bg-[#F37021] mt-2 shadow-lg shadow-orange-200"></div>
                                                        <div><p className="font-black text-slate-800 text-2xl">{t.title}</p><p className="text-xs text-slate-400 font-bold mt-2 uppercase italic">{formatDate(t.startDate)} - {formatDate(t.endDate)} · 負責：{t.assignee}</p></div>
                                                    </div>
                                                ))}
                                                {newsletter.nextMonth.length === 0 && <p className="text-slate-300 font-bold italic text-center">下月暫無計畫任務</p>}
                                            </div>
                                        </section>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 3. 常規管理頁面 */}
                        {activeTab === 'routine' && (
                            <div className="max-w-6xl mx-auto space-y-10 animate-in fade-in">
                                <header className="flex justify-between items-end">
                                    <div><h2 className="text-4xl font-black text-slate-900 tracking-tighter uppercase">常規事項中心</h2><p className="text-[#F37021] font-bold mt-2">護理站每日/週/月固定行政清單</p></div>
                                    <button onClick={()=>setShowImportModal(true)} className="bg-white border-2 border-orange-100 text-slate-500 px-8 py-4 rounded-3xl font-black shadow-sm flex items-center gap-2 hover:bg-orange-50 transition-all"><Icon name="Upload"/> 批量匯入 CSV</button>
                                </header>
                                <div className="bg-white rounded-[3rem] border border-orange-100 overflow-hidden shadow-sm">
                                    <div className="p-10 bg-orange-50/20 border-b border-orange-100">
                                        <form onSubmit={handleAddRoutine} className="flex flex-wrap gap-8 items-end">
                                            <div className="flex-1 min-w-[250px] space-y-2"><label className="text-[10px] font-black text-slate-400 ml-2 uppercase tracking-widest">常規工作名稱</label><input required className="w-full border-2 border-orange-100 rounded-2xl px-6 py-4 outline-none font-black shadow-inner" placeholder="醫藥箱點檢..." value={newRoutine.title} onChange={e=>setNewRoutine({...newRoutine, title:e.target.value})}/></div>
                                            <div className="space-y-2"><label className="text-[10px] font-black text-slate-400 ml-2 uppercase">週期頻率</label><select className="border-2 border-orange-100 rounded-2xl px-8 py-4 bg-white font-black" value={newRoutine.frequency} onChange={e=>setNewRoutine({...newRoutine, frequency:e.target.value})}><option>每日</option><option>每週</option><option>每月</option><option>每半年</option></select></div>
                                            <div className="space-y-2"><label className="text-[10px] font-black text-slate-400 ml-2 uppercase">固定負責人</label><select required className="border-2 border-orange-100 rounded-2xl px-8 py-4 bg-white font-black" value={newRoutine.assignee} onChange={e=>setNewRoutine({...newRoutine, assignee:e.target.value})}><option value="">請選擇</option>{memberNames.map(n=><option key={n}>{n}</option>)}</select></div>
                                            <button className="bg-[#F37021] text-white px-12 py-4 rounded-2xl font-black shadow-xl mb-1">加入常規</button>
                                        </form>
                                    </div>
                                    <table className="w-full text-left">
                                        <thead className="bg-slate-50 text-[10px] uppercase font-black text-slate-400 border-b"><th className="px-12 py-8 tracking-widest">工作內容</th><th className="px-12 py-8 tracking-widest">執行頻率</th><th className="px-12 py-8 tracking-widest">指定人員</th><th className="px-12 py-8 text-right tracking-widest">管理</th></thead>
                                        <tbody className="divide-y divide-orange-50">
                                            {routines.map(r=>(
                                                <tr key={r.id} className="hover:bg-orange-50/10 transition-colors"><td className="px-12 py-8 font-black text-slate-800 text-xl tracking-tight">{r.title}</td><td className="px-12 py-8"><span className="bg-orange-100 text-[#F37021] px-5 py-2 rounded-full text-[11px] font-black border border-orange-200">{r.frequency}</span></td><td className="px-12 py-8 font-bold text-slate-500 italic">{r.assignee}</td><td className="px-12 py-8 text-right"><button onClick={()=>setRoutines(routines.filter(rk=>rk.id!==r.id))} className="text-slate-200 hover:text-red-500 p-4 transition-colors"><Icon name="Trash2" size={24}/></button></td></tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {/* 4. 系統設定 (成員編輯) */}
                        {activeTab === 'settings' && (
                            <div className="max-w-4xl mx-auto space-y-12 animate-in fade-in">
                                <h2 className="text-4xl font-black text-slate-900 tracking-tighter uppercase leading-none">團隊與系統管理</h2>
                                <div className="bg-white rounded-[3.5rem] p-16 border border-orange-100 shadow-sm space-y-10">
                                    <h3 className="font-black text-[#F37021] text-3xl flex items-center gap-4 italic uppercase"><Icon name="Users" size={36}/> 護理師團隊名單</h3>
                                    <div className="flex gap-4"><input className="flex-1 border-2 border-orange-100 rounded-[2rem] px-8 py-5 outline-none font-black text-xl shadow-inner bg-orange-50/30 focus:bg-white" placeholder="新成員姓名..." value={newMemberName} onChange={e=>setNewMemberName(e.target.value)} onKeyDown={e=>e.key==='Enter'&&document.getElementById('addBtn').click()}/><button id="addBtn" onClick={()=>{if(newMemberName){setMembers([...members,{id:'m'+Date.now(),name:newMemberName}]); setNewMemberName(''); showMsg('成員已新增');}}} className="bg-[#F37021] text-white px-12 py-5 rounded-[2rem] font-black shadow-xl hover:bg-black transition-all">新增</button></div>
                                    <div className="space-y-4">
                                        {members.map(m=>(<div key={m.id} className="flex justify-between items-center p-8 bg-orange-50/20 rounded-[2.5rem] px-12 border border-transparent hover:border-orange-100 transition-all"><span className="font-black text-slate-800 text-3xl tracking-tighter">{m.name}</span><button onClick={()=>setMembers(members.filter(me=>me.id!==m.id))} className="text-red-100 hover:text-red-500 p-4 transition-colors"><Icon name="Trash2" size={28}/></button></div>))}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* 5. 個人工作中心 */}
                        {memberNames.includes(activeTab) && (
                             <div className="max-w-6xl mx-auto space-y-12 animate-in fade-in duration-500">
                                <header className="flex items-center gap-10">
                                    <div className="w-28 h-28 kerry-gradient rounded-[3rem] flex items-center justify-center text-white text-6xl font-black shadow-2xl">{activeTab.charAt(0)}</div>
                                    <div><h2 className="text-5xl font-black text-slate-900 tracking-tighter uppercase">{activeTab} 的雲端工作中心</h2><p className="text-[#F37021] font-black uppercase text-sm italic mt-4 tracking-[0.3em]">Personal Workspace</p></div>
                                </header>
                                <div className="grid lg:grid-cols-2 gap-10">
                                    <div className="bg-white p-12 rounded-[4rem] border border-orange-100 shadow-sm min-h-[500px]">
                                        <h3 className="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] mb-10 border-l-8 border-[#F37021] pl-6 italic">已分派專案任務</h3>
                                        <div className="space-y-5 flex-1">
                                            {tasks.filter(t=>t.assignee===activeTab).map(t=>(
                                                <div key={t.id} className="p-8 bg-orange-50/20 rounded-[2.5rem] border border-orange-100 flex items-center gap-6 group hover:bg-white transition-all">
                                                    <button onClick={() => setTasks(tasks.map(tk => tk.id===t.id?{...tk,status:tk.status==='completed'?'pending':'completed'}:tk))} className={t.status === 'completed' ? 'text-emerald-500' : 'text-slate-300'}><Icon name="CheckCircle2" size={32} /></button>
                                                    <div><p className={`text-xl font-black tracking-tight ${t.status==='completed'?'line-through text-slate-300 font-normal':''}`}>{t.title}</p><p className="text-xs text-slate-400 font-bold mt-2 uppercase italic">{formatDate(t.startDate)} - {formatDate(t.endDate)}</p></div>
                                                </div>
                                            ))}
                                            {tasks.filter(t=>t.assignee===activeTab).length===0 && <p className="py-20 text-center font-black text-slate-200 italic text-xl">目前暫無任務</p>}
                                        </div>
                                    </div>
                                    <div className="bg-white p-12 rounded-[4rem] border border-orange-100 shadow-sm min-h-[500px]">
                                        <h3 className="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] mb-10 border-l-8 border-emerald-400 pl-6 italic">固定常規行政</h3>
                                        <div className="space-y-5">
                                            {routines.filter(r=>r.assignee===activeTab).map(r=>(
                                                <div key={r.id} className="p-8 bg-slate-50 rounded-[2.5rem] border border-slate-100 group hover:border-[#F37021] transition-all"><p className="text-2xl font-black text-slate-800 tracking-tight group-hover:text-[#F37021] transition-colors">{r.title}</p><p className="text-xs text-[#F37021] font-black mt-4 uppercase tracking-[0.2em]">週期：{r.frequency}</p></div>
                                            ))}
                                            {routines.filter(r=>r.assignee===activeTab).length===0 && <p className="py-20 text-center font-black text-slate-200 italic text-xl">目前無常規事務</p>}
                                        </div>
                                    </div>
                                </div>
                             </div>
                        )}
                    </main>

                    {/* --- MODALS --- */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-xl z-[60] flex items-center justify-center p-6">
                            <div className="bg-white rounded-[4rem] w-full max-w-xl p-16 shadow-2xl animate-in zoom-in duration-300">
                                <h3 className="text-4xl font-black mb-10 tracking-tighter uppercase italic text-slate-900 border-b-4 border-[#F37021] pb-4 inline-block">啟動年度大專案</h3>
                                <form onSubmit={handleAddProject} className="space-y-8">
                                    <div className="space-y-2"><label className="text-[10px] font-black text-slate-400 uppercase ml-2">Project Title</label><input required className="w-full border-2 border-orange-50 rounded-[2rem] px-8 py-5 outline-none font-black text-xl bg-orange-50/30 focus:bg-white transition-all" placeholder="輸入專案名稱..." value={projectForm.title} onChange={e=>setProjectForm({...projectForm, title:e.target.value})} /></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="space-y-2"><label className="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">START</label><input type="date" required className="w-full border-2 border-orange-50 rounded-[1.5rem] px-6 py-4 font-bold bg-orange-50/30" value={projectForm.startDate} onChange={e=>setProjectForm({...projectForm, startDate:e.target.value})} /></div>
                                        <div className="space-y-2"><label className="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">END</label><input type="date" required className="w-full border-2 border-orange-50 rounded-[1.5rem] px-6 py-4 font-bold bg-orange-50/30" value={projectForm.endDate} onChange={e=>setProjectForm({...projectForm, endDate:e.target.value})} /></div>
                                    </div>
                                    <div className="space-y-2"><label className="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">Primary Leader</label><select required className="w-full border-2 border-orange-50 rounded-[2rem] px-8 py-5 font-black text-lg bg-white" value={projectForm.leader} onChange={e=>setProjectForm({...projectForm, leader:e.target.value})}><option value="">請選擇專案負責人</option>{memberNames.map(n=><option key={n} value={n}>{n}</option>)}</select></div>
                                    <div className="flex flex-col gap-4 pt-4">
                                        <button className="w-full kerry-gradient text-white py-6 rounded-[2rem] font-black shadow-2xl text-2xl hover:scale-105 active:scale-95 transition-all">Create Project</button>
                                        <button type="button" onClick={()=>setIsModalOpen(false)} className="w-full text-slate-300 font-bold uppercase tracking-widest text-sm">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                    
                    {isEditModalOpen && (
                        <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-xl z-[60] flex items-center justify-center p-6">
                            <div className="bg-white rounded-[4rem] w-full max-w-xl p-16 shadow-2xl animate-in zoom-in duration-300">
                                <h3 className="text-3xl font-black mb-10 tracking-tighter uppercase italic">編輯專案主檔</h3>
                                <div className="space-y-8">
                                    <input className="w-full border-2 border-orange-50 rounded-[2rem] px-8 py-5 outline-none font-black text-xl" value={projectForm.title} onChange={e=>setProjectForm({...projectForm, title:e.target.value})} />
                                    <div className="flex gap-4">
                                        <button onClick={()=>{setProjects(projects.map(p=>p.id===projectForm.id?projectForm:p)); setIsEditModalOpen(false); showMsg('專案已更新');}} className="flex-1 bg-slate-900 text-white py-5 rounded-[2rem] font-black text-xl shadow-xl">儲存修改</button>
                                        <button onClick={()=>{if(confirm('確定刪除？此操作不可恢復。')){setProjects(projects.filter(p=>p.id!==projectForm.id)); setTasks(tasks.filter(tk=>tk.projectId!==projectForm.id)); setIsEditModalOpen(false); showMsg('專案已永久刪除');}}} className="bg-red-50 text-red-500 px-8 py-5 rounded-[2rem] font-black">永久刪除</button>
                                    </div>
                                    <button onClick={()=>setIsEditModalOpen(false)} className="w-full text-slate-300 font-bold uppercase text-sm tracking-widest">Close</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showImportModal && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[60] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[3.5rem] w-full max-w-2xl p-16 shadow-2xl animate-in zoom-in duration-300">
                                <h3 className="text-3xl font-black mb-6 flex items-center gap-4 italic tracking-tight uppercase"><Icon name="Upload" className="text-[#F37021]" size={32}/> 批量 CSV 匯入</h3>
                                <p className="text-xs text-slate-400 font-bold mb-6 border-l-4 border-orange-200 pl-4 uppercase tracking-widest">格式：項目名稱,頻率,負責人 (每行一筆資料)</p>
                                <textarea className="w-full h-72 border-2 border-orange-50 rounded-[2.5rem] p-8 outline-none bg-slate-50 mb-8 font-bold text-slate-600 shadow-inner" placeholder="醫藥箱點檢,每月,羽瑩&#10;AED檢查,每週,嘉莉" value={importText} onChange={e=>setImportText(e.target.value)} />
                                <div className="flex gap-4">
                                    <button onClick={handleImportCSV} className="flex-1 kerry-gradient text-white py-5 rounded-[2rem] font-black text-xl shadow-2xl hover:scale-105 transition-all">執行批量匯入</button>
                                    <button onClick={()=>setShowImportModal(false)} className="px-8 py-5 text-slate-400 font-black uppercase text-sm tracking-widest">取消離開</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
