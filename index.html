<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 血壓智能紀錄助手 (本地版)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SheetJS (用於匯出 Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- 左側：輸入面板 -->
        <div class="lg:col-span-5 space-y-6">
            <header class="bg-white rounded-3xl p-6 shadow-sm flex items-center justify-between border border-slate-200">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2.5 rounded-2xl text-white shadow-lg">
                        <i data-lucide="activity" size="28"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-black tracking-tight">AI 血壓助手</h1>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">本地儲存版 v6.0</p>
                    </div>
                </div>
                <div id="scan-status" class="hidden flex items-center gap-2 bg-blue-50 text-blue-600 px-3 py-1.5 rounded-xl font-bold text-[10px]">
                    <i data-lucide="loader-2" class="animate-spin w-4 h-4"></i>
                    <span id="status-text">處理中...</span>
                </div>
            </header>

            <section class="bg-white rounded-[2rem] shadow-xl p-6 md:p-8 border border-white">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-lg font-bold flex items-center gap-2 text-slate-600">
                        <i data-lucide="clipboard-check" class="text-blue-500"></i>
                        數據錄入
                    </h2>
                    <label class="flex items-center gap-2 bg-slate-900 text-white px-5 py-3 rounded-2xl cursor-pointer hover:bg-blue-600 transition-all font-black text-xs shadow-xl active:scale-95 group">
                        <i data-lucide="camera" class="w-5 h-5"></i>
                        拍照辨識
                        <input type="file" id="camera-input" accept="image/*" capture="camera" class="hidden">
                    </label>
                </div>

                <!-- 照片預覽區 -->
                <div id="preview-container" class="hidden mb-6 p-2.5 bg-blue-50 rounded-2xl flex items-center gap-4 border border-blue-100 animate-in">
                    <img id="image-preview" src="" class="w-20 h-20 object-cover rounded-xl shadow-md border-2 border-white">
                    <div class="flex-1">
                        <p class="text-sm font-black text-blue-700">影像已載入</p>
                        <p class="text-[10px] text-blue-400 font-bold">AI 已自動提取數據，請核對。</p>
                    </div>
                    <button id="clear-image" class="p-2 text-blue-300 hover:text-blue-600">
                        <i data-lucide="x"></i>
                    </button>
                </div>

                <form id="health-form" class="space-y-6">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 block mb-2 uppercase tracking-widest">員工工號</label>
                        <div class="relative">
                            <i data-lucide="user" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 w-5 h-5"></i>
                            <input type="text" id="employeeId" required placeholder="請輸入工號" class="w-full pl-12 pr-4 py-5 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-blue-500 focus:bg-white outline-none font-bold text-xl transition-all">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-black text-slate-400 block mb-2 uppercase tracking-widest text-center">收縮壓 (高壓)</label>
                            <input type="number" id="systolic" required placeholder="SYS" class="w-full py-6 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-rose-400 focus:bg-white outline-none font-black text-4xl text-rose-600 text-center transition-all">
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 block mb-2 uppercase tracking-widest text-center">舒張壓 (低壓)</label>
                            <input type="number" id="diastolic" required placeholder="DIA" class="w-full py-6 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-rose-400 focus:bg-white outline-none font-black text-4xl text-rose-600 text-center transition-all">
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] font-black text-slate-400 block mb-2 uppercase tracking-widest">脈搏</label>
                        <div class="relative">
                            <i data-lucide="heart" class="absolute left-4 top-1/2 -translate-y-1/2 text-orange-400 w-5 h-5"></i>
                            <input type="number" id="pulse" required placeholder="BPM" class="w-full pl-12 pr-4 py-5 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-orange-400 focus:bg-white outline-none font-black text-xl text-orange-600 transition-all">
                        </div>
                    </div>

                    <button type="submit" class="w-full py-5 bg-slate-900 text-white rounded-[1.5rem] font-black text-xl shadow-xl hover:bg-blue-600 transition-all flex items-center justify-center gap-3 active:scale-95">
                        儲存至本地 <i data-lucide="save"></i>
                    </button>
                </form>
            </section>
        </div>

        <!-- 右側：歷史清單 -->
        <div class="lg:col-span-7 flex flex-col gap-6">
            <div class="bg-white p-6 md:p-8 rounded-[2rem] shadow-sm border border-slate-200 flex flex-col h-[85vh]">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                    <h2 class="text-xl font-black flex items-center gap-3 text-slate-600">
                        <i data-lucide="clock" class="text-slate-300"></i> 本地紀錄清單
                    </h2>
                    <div class="flex gap-2">
                        <button id="export-btn" class="flex items-center gap-2 bg-emerald-600 text-white px-4 py-2.5 rounded-xl font-bold text-xs hover:bg-emerald-700 transition-all shadow-md active:scale-95">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                            匯出 Excel
                        </button>
                        <button id="clear-all-btn" class="flex items-center gap-2 bg-slate-100 text-slate-500 px-4 py-2.5 rounded-xl font-bold text-xs hover:bg-rose-50 hover:text-rose-600 transition-all active:scale-95">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            清空
                        </button>
                    </div>
                </div>

                <div class="relative mb-4">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                    <input type="text" id="search-input" placeholder="搜尋工號..." class="w-full pl-10 pr-4 py-3 bg-slate-50 border-none rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div id="records-list" class="space-y-3 flex-1 overflow-y-auto pr-2 custom-scroll pb-4">
                    <!-- 紀錄會動態生成於此 -->
                    <div class="text-center py-24 text-slate-300">目前尚無本地紀錄</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 圖片彈窗 -->
    <div id="modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-slate-900/90 backdrop-blur-md">
        <div class="relative bg-white p-2 rounded-[2.5rem] max-w-xl w-full shadow-2xl">
            <button id="close-modal" class="absolute top-4 right-4 bg-black/50 text-white p-2 rounded-full hover:bg-black">
                <i data-lucide="x"></i>
            </button>
            <img id="modal-image" src="" class="w-full h-auto rounded-[2rem]">
        </div>
    </div>

    <script type="module">
        // --- 設定 ---
        const apiKey = ""; // Gemini API Key
        const STORAGE_KEY = 'local_health_records';

        // --- 資料狀態 ---
        let records = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        let capturedImageBase64 = null;

        // --- 初始化 ---
        window.addEventListener('DOMContentLoaded', () => {
            renderRecords();
            lucide.createIcons();
        });

        // --- 核心功能：渲染列表 ---
        function renderRecords() {
            const list = document.getElementById('records-list');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            // 過濾資料
            const filtered = records
                .filter(r => r.employeeId.toLowerCase().includes(searchTerm))
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (filtered.length === 0) {
                list.innerHTML = `<div class="text-center py-20 text-slate-300 font-bold">沒有符合的紀錄</div>`;
                return;
            }

            list.innerHTML = filtered.map(r => {
                const health = analyzeHealth(r.systolic, r.diastolic);
                const time = new Date(r.timestamp).toLocaleString('zh-TW', { hour12: false });
                return `
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between gap-4 animate-in">
                        <div class="flex items-center gap-4 flex-1">
                            <div class="w-12 h-12 rounded-xl flex flex-col items-center justify-center font-black ${health.bg} ${health.color}">
                                <span class="text-[8px] uppercase opacity-60">判定</span>
                                <span class="text-[10px]">${health.label}</span>
                            </div>
                            <div class="min-w-0">
                                <div class="flex items-center gap-2">
                                    <span class="font-black text-slate-700 truncate">工號: ${r.employeeId}</span>
                                    ${r.image ? `<button onclick="viewImage('${r.image}')" class="text-blue-500 hover:underline text-[10px] font-bold shrink-0">影像證明</button>` : ''}
                                </div>
                                <div class="flex flex-wrap gap-x-4 gap-y-1 mt-1">
                                    <span class="text-sm font-bold text-slate-500">${r.systolic}/${r.diastolic} <small class="font-normal opacity-60">mmHg</small></span>
                                    <span class="text-sm font-bold text-orange-500">${r.pulse} <small class="font-normal opacity-60">BPM</small></span>
                                    <span class="text-[10px] text-slate-300 flex items-center">${time}</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="deleteRecord('${r.id}')" class="p-2 text-slate-200 hover:text-rose-500 transition-colors">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function analyzeHealth(s, d) {
            if (s >= 140 || d >= 90) return { label: '高血壓', color: 'text-rose-600', bg: 'bg-rose-50' };
            if (s >= 130 || d >= 80) return { label: '偏高', color: 'text-amber-600', bg: 'bg-amber-50' };
            return { label: '正常', color: 'text-emerald-600', bg: 'bg-emerald-50' };
        }

        // --- AI 辨識 ---
        document.getElementById('camera-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            showStatus('正在處理影像...', true);
            const storageImg = await resizeImage(file, 400, 0.5);
            const aiImg = await resizeImage(file, 1024, 0.8);
            
            capturedImageBase64 = storageImg;
            document.getElementById('image-preview').src = storageImg;
            document.getElementById('preview-container').classList.remove('hidden');

            showStatus('AI 智能辨識中...', true);
            try {
                const result = await callGemini(aiImg.split(',')[1]);
                if (result) {
                    document.getElementById('systolic').value = result.systolic || '';
                    document.getElementById('diastolic').value = result.diastolic || '';
                    document.getElementById('pulse').value = result.pulse || '';
                }
                showStatus('', false);
            } catch (err) {
                alert('AI 辨識失敗，請手動輸入數值。');
                showStatus('', false);
            }
        });

        async function callGemini(base64) {
            const prompt = "Analyze this blood pressure monitor photo. Extract: systolic, diastolic, and pulse rate. Return ONLY valid JSON: {\"systolic\": number, \"diastolic\": number, \"pulse\": number}.";
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64 } }] }],
                    generationConfig: { responseMimeType: "application/json" }
                })
            });
            const data = await response.json();
            return JSON.parse(data.candidates[0].content.parts[0].text);
        }

        // --- 儲存與管理 ---
        document.getElementById('health-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const newRecord = {
                id: Date.now().toString(),
                employeeId: document.getElementById('employeeId').value,
                systolic: parseInt(document.getElementById('systolic').value),
                diastolic: parseInt(document.getElementById('diastolic').value),
                pulse: parseInt(document.getElementById('pulse').value),
                image: capturedImageBase64,
                timestamp: new Date().toISOString()
            };

            records.push(newRecord);
            saveToLocal();
            
            // 重置表單
            document.getElementById('health-form').reset();
            document.getElementById('preview-container').classList.add('hidden');
            capturedImageBase64 = null;
            renderRecords();
        });

        function saveToLocal() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
        }

        window.deleteRecord = (id) => {
            if (confirm('確定要刪除這筆紀錄嗎？')) {
                records = records.filter(r => r.id !== id);
                saveToLocal();
                renderRecords();
            }
        };

        document.getElementById('clear-all-btn').onclick = () => {
            if (confirm('確定要清空「這台裝置」上的所有歷史紀錄嗎？（不可還原）')) {
                records = [];
                saveToLocal();
                renderRecords();
            }
        };

        // --- Excel 匯出功能 ---
        document.getElementById('export-btn').onclick = () => {
            if (records.length === 0) {
                alert('目前尚無資料可供匯出。');
                return;
            }

            // 準備 Excel 資料格式
            const dataForExcel = records.map(r => ({
                '量測時間': new Date(r.timestamp).toLocaleString('zh-TW'),
                '員工工號': r.employeeId,
                '收縮壓(高壓)': r.systolic,
                '舒張壓(低壓)': r.diastolic,
                '脈搏(BPM)': r.pulse,
                '判定結果': analyzeHealth(r.systolic, r.diastolic).label
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataForExcel);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "健康紀錄");

            // 匯出檔案
            const fileName = `血壓紀錄匯出_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(workbook, fileName);
        };

        // --- 其他 UI 功能 ---
        window.viewImage = (src) => {
            document.getElementById('modal-image').src = src;
            document.getElementById('modal').classList.remove('hidden');
        };

        document.getElementById('close-modal').onclick = () => document.getElementById('modal').classList.add('hidden');
        document.getElementById('clear-image').onclick = () => {
            capturedImageBase64 = null;
            document.getElementById('preview-container').classList.add('hidden');
        };
        document.getElementById('search-input').oninput = renderRecords;

        function showStatus(text, show) {
            const status = document.getElementById('scan-status');
            document.getElementById('status-text').innerText = text;
            status.classList.toggle('hidden', !show);
        }

        function resizeImage(file, maxWidth, quality) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h = (maxWidth / w) * h; w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                };
            });
        }
    </script>
</body>
</html>
